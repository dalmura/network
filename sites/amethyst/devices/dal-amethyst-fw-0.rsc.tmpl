#
# dal-amethyst-fw-0
#

#
# Naming
#

/system/identity/set name="dal-amethyst-fw-0"


#
# Network Overview
#

# 100 = GENERAL         = 192.168.69.0/24    = 254

#
# Bridge
#

/interface/bridge/add name=CORE vlan-filtering=no

/interface/bridge/port

# untagged - GENERAL
add bridge=CORE interface=ether2       pvid=100 comment=""

# untagged - GENERAL
add bridge=CORE interface=ether3       pvid=100 comment=""

# untagged - GENERAL
add bridge=CORE interface=ether4       pvid=100 comment=""

# untagged - GENERAL
add bridge=CORE interface=ether5       pvid=100 comment=""

# trunk
add bridge=CORE interface=sfp-sfpplus1 comment=""

/interface/bridge/vlan
add bridge=CORE tagged=CORE,sfp-sfpplus1 untagged=ether2,ether3,ether4,ether5,vlan-ids=100

#
# IP Addressing & Routing
#

# General VLAN
/interface/vlan/add interface=CORE name=GENERAL_VLAN vlan-id=100
/ip/address/add interface=GENERAL_VLAN address=192.168.69.1/24
/ip/pool/add name=general-dhcp ranges=192.168.69.100-192.168.69.254
/ip/dhcp-server/add address-pool=general-dhcp interface=GENERAL_VLAN name=general-dhcp disabled=no
/ip/dhcp-server/network/add address=192.168.69.0/24 dns-server=192.168.69.1 gateway=192.168.69.1 comment="GENERAL_VLAN"

{% if static_dhcp_leases -%}
# Optional Static DHCP Leases
/ip/dhcp-server/lease
{% for lease in static_dhcp_leases -%}
  add address={{ lease.address }} server={{ lease.server }} mac-address={{ lease.mac_address }} comment="{{ lease.comment }}"
{% endfor %}
{% endif %}


#
# Firewall & NAT
#

/interface/list
add name=WAN
add name=WAN_HUB
add name=WAN_SPOKE
add name=VLAN
add name=LAN
add name=INTERNET_ONLY
add name=BLACKHOLE
add name=MANAGEMENT
add name=INTERNAL_PUBLIC_ACCESS
add name=INTERNAL_PRIVATE_ACCESS

/interface/list/member
add interface=ether1               list=WAN
add interface=GENERAL_VLAN         list=VLAN
add interface=GENERAL_VLAN         list=LAN
add interface=GENERAL_VLAN         list=INTERNAL_PUBLIC_ACCESS
add interface=GENERAL_VLAN         list=INTERNAL_PRIVATE_ACCESS

/ip/firewall/filter

# Input Chain
add chain=input action=accept connection-state=established,related,untracked comment="accept established,related,untracked"
add chain=input action=drop connection-state=invalid comment="drop invalid"
add chain=input action=accept dst-address=127.0.0.1 comment="accept to local loopback (for CAPsMAN)"

# Add more general input related access here
add chain=input action=accept protocol=icmp in-interface-list=LAN comment="accept ICMP from non-restricted"
add chain=input action=accept protocol=udp dst-port=53 in-interface-list=VLAN comment="accept DNS from internal networks"
add chain=input action=accept src-address=0.0.0.0 dst-address=255.255.255.255 protocol=udp src-port=68 dst-port=67 in-interface-list=VLAN comment="allow DHCP broadcasts"
add chain=input action=accept in-interface=GENERAL_VLAN comment="allow GENERAL_VLAN access"
# Line above will change from GENERAL_VLAN to MANAGEMENT_VLAN when tom can be bothered

# Legacy IPSec
add chain=input action=accept protocol=udp src-port=4500 in-interface-list=WAN comment="Legacy IPSec"
add chain=input action=accept protocol=ipsec-esp in-interface-list=WAN comment="Legacy IPSec"
add chain=input action=accept protocol=gre in-interface-list=WAN ipsec-policy=in,ipsec comment="Legacy IPSec - GRE"
add chain=input action=accept protocol=tcp dst-port=179 in-interface-list=WAN ipsec-policy=in,ipsec comment="Legacy IPSec - BGP"

# Finally drop everything else
add chain=input action=accept log=yes log-prefix=input-catch comment="catchall" disabled=yes
add chain=input action=drop log=no log-prefix=input-drop comment="drop all other input"

# Forward Chain
add chain=forward action=fasttrack-connection connection-state=established comment="fasttrack"
add chain=forward action=accept connection-state=established,related,untracked comment="accept established,related,untracked"
add chain=forward action=drop connection-state=invalid comment="drop invalid"
add chain=forward action=drop in-interface-list=WAN connection-state=new connection-nat-state=!dstnat comment="drop all from WAN not DSTNATed"

# Add more general forward related access here

## Allow internet access
add chain=forward action=accept in-interface-list=LAN out-interface-list=WAN comment="accept LAN to WAN"
add chain=forward action=accept connection-state=new in-interface-list=INTERNET_ONLY out-interface-list=WAN comment="accept INTERNET_ONLY to WAN"

## Allow LAN => WAN_HUB
add chain=forward action=accept in-interface-list=LAN out-interface-list=WAN_HUB comment="accept LAN => WAN_HUB" log-prefix="lan2wanhub"

# Finally drop everything else
add chain=forward action=accept log=yes log-prefix=forward-catch comment="catchall" disabled=yes
add chain=forward action=drop log=no log-prefix=forward-drop comment="drop all other forward"

#
# NAT
#

/ip/firewall/nat

# Masquerade outgoing packets as WAN IP
add chain=srcnat out-interface-list=WAN ipsec-policy=out,none action=masquerade comment="Default masquerade"

# Add more general NAT access here


#
# VLAN Security
#

/interface/bridge/port
set bridge=CORE ingress-filtering=yes frame-types=admit-only-untagged-and-priority-tagged [find interface=ether2]
set bridge=CORE ingress-filtering=yes frame-types=admit-only-untagged-and-priority-tagged [find interface=ether3]
set bridge=CORE ingress-filtering=yes frame-types=admit-only-untagged-and-priority-tagged [find interface=ether4]
set bridge=CORE ingress-filtering=yes frame-types=admit-only-untagged-and-priority-tagged [find interface=ether5]
set bridge=CORE ingress-filtering=yes frame-types=admit-only-vlan-tagged [find interface=sfp-sfpplus1]


#
# MAC Server
#

/ip/neighbor/discovery-settings/set discover-interface-list=LAN
/tool/mac-server/mac-winbox/set allowed-interface-list=LAN
/tool/mac-server/set allowed-interface-list=LAN


#
# Enable VLAN Filtering
#

/interface/bridge/set CORE vlan-filtering=yes

#
# WAN Setup
#

/ip/dhcp-client/add interface=ether1 use-peer-dns=no use-peer-ntp=no add-default-route=yes dhcp-options=""

# General router settings
/ip/dns/set allow-remote-requests=yes servers="1.1.1.1,8.8.8.8"
/ip/cloud/set ddns-enabled=yes ddns-update-interval=15m update-time=yes

# Wait until the system clock updates
# Anything below here is sensitive to system time
/log info "Waiting for system clock update"
:do { :delay 1s } while=([:timestamp] < 2728w)


#
# Certificates
#

/certificate
{% if device_upgrade -%}
import name=root-ca passphrase="{{ cert_export_passphrase }}" file-name=internal-amethyst-root-ca.crt
import name=root-ca passphrase="{{ cert_export_passphrase }}" file-name=internal-amethyst-root-ca.key
import name=server  passphrase="{{ cert_export_passphrase }}" file-name=internal-amethyst.crt
import name=server  passphrase="{{ cert_export_passphrase }}" file-name=internal-amethyst.key

:delay 4

set root-ca trusted=yes
set server  trusted=yes
{% else %}
add name=ca days-valid=10950 common-name=fw-0.amethyst.dalmura.cloud key-usage=key-cert-sign,crl-sign
add name=server days-valid=10950 common-name=fw-0.amethyst.dalmura.cloud subject-alt-name=DNS:fw-0.amethyst.dalmura.cloud organization=dalmura unit=amethyst

sign ca name=root-ca
:delay 2
sign ca=root-ca server name=server
:delay 2

set root-ca trusted=yes
set server trusted=yes

# Export certs for use in remote systems
# No private key material is exported here, just the public crt
export-certificate file-name=remote-amethyst type=pem server
export-certificate file-name=remote-amethyst-root-ca type=pem root-ca

{% if cert_export_passphrase %}
# Private key material is exported here
export-certificate file-name=internal-amethyst type=pem export-passphrase="{{ cert_export_passphrase }}" server
export-certificate file-name=internal-amethyst-root-ca type=pem export-passphrase="{{ cert_export_passphrase }}" root-ca
{% endif %}
{% endif %}

# Web UI certificate
/ip/service/set www-ssl tls-version=only-1.2 address=192.168.69.0/24 certificate=server disabled=no
/ip/service/set api-ssl tls-version=only-1.2 address=192.168.69.0/24 certificate=server disabled=no


#
# Legacy IPSec
#

# IKE Phase 1
/ip/ipsec/profile
add name=dalmura hash-algorithm=sha256 enc-algorithm=aes-256 dh-group=modp2048,modp4096,ecp521 nat-traversal=no dpd-interval=30 dpd-maximum-failures=5

/ip/ipsec/peer
add name=indigo   address=indigo.dalmura.cloud   profile=dalmura exchange-mode=ike2 passive=no send-initial-contact=yes
add name=salmon   address=salmon.dalmura.cloud   profile=dalmura exchange-mode=ike2 passive=no send-initial-contact=yes
add name=cerulean address=cerulean.dalmura.cloud profile=dalmura exchange-mode=ike2 passive=no send-initial-contact=yes

# This step will fail unless remote certificates have been uploaded to the device
/certificate
import name=remote-indigo-root-ca file-name=remote-indigo-root-ca.crt
import name=remote-indigo         file-name=remote-indigo.crt
:delay 2

import name=remote-salmon-root-ca file-name=remote-salmon-root-ca.crt
import name=remote-salmon         file-name=remote-salmon.crt
:delay 2

import name=remote-cerulean-root-ca file-name=remote-cerulean-root-ca.crt
import name=remote-cerulean         file-name=remote-cerulean.crt
:delay 2

/ip/ipsec/identity
add peer=indigo   auth-method=digital-signature certificate=server match-by=certificate remote-certificate=remote-indigo
add peer=salmon   auth-method=digital-signature certificate=server match-by=certificate remote-certificate=remote-salmon
add peer=cerulean auth-method=digital-signature certificate=server match-by=certificate remote-certificate=remote-cerulean

# IKE Phase 2
/ip/ipsec/proposal
add name=dalmura auth-algorithms=sha256 enc-algorithms=aes-256-cbc lifetime=08:00:00 pfs-group=modp2048

/ip/ipsec/policy
add peer=indigo   tunnel=yes src-address=172.16.0.17 dst-address=172.16.0.18 action=encrypt level=require ipsec-protocols=esp proposal=dalmura
add peer=salmon   tunnel=yes src-address=172.16.0.5  dst-address=172.16.0.6  action=encrypt level=require ipsec-protocols=esp proposal=dalmura
add peer=cerulean tunnel=yes src-address=172.16.0.37 dst-address=172.16.0.38 action=encrypt level=require ipsec-protocols=esp proposal=dalmura

# GRE tunnel interfaces
/interface/gre
add name=indigo   local-address=172.16.0.17 remote-address=172.16.0.18 allow-fast-path=no
add name=salmon   local-address=172.16.0.5  remote-address=172.16.0.6  allow-fast-path=no
add name=cerulean local-address=172.16.0.37 remote-address=172.16.0.38 allow-fast-path=no

/ip/address
add address=172.16.0.17 network=172.16.0.16 interface=indigo
add address=172.16.0.5  network=172.16.0.4  interface=salmon
add address=172.16.0.37 network=172.16.0.36 interface=cerulean

/interface/list/member
add interface=indigo   list=WAN_HUB
add interface=salmon   list=WAN_HUB
add interface=cerulean list=WAN_HUB

# BGP
/ip/firewall/address-list
add list=amethyst-bgp-networks address=192.168.68.0/22

# Required for the network above to be advertised correctly to BGP peers
/ip/route
add dst-address=192.168.68.0/22 blackhole

/routing/bgp/template
add name=amethyst-hub   as=65210 router-id=192.168.68.0 output.network=amethyst-bgp-networks
add name=amethyst-spoke as=65210 router-id=192.168.68.0 output.network=amethyst-bgp-networks

/routing/bgp/connection
add name=indigo   template=amethyst-hub local.address=172.16.0.17 local.role=ebgp remote.address=172.16.0.18 remote.as=65208
add name=salmon   template=amethyst-hub local.address=172.16.0.5  local.role=ebgp remote.address=172.16.0.6  remote.as=65207
add name=cerulean template=amethyst-hub local.address=172.16.0.37 local.role=ebgp remote.address=172.16.0.38 remote.as=65209
